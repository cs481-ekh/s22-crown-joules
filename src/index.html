<!DOCTYPE html>

<html>
    <title>
        Crown Joules
    </title>
    <head>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" crossorigin="anonymous">
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" crossorigin="anonymous"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
        <link href="styles.css" rel="stylesheet">
    </head>
    <body>
        <div id="grid-container">
            <div id="main-canvas">
                <div>CANVAS</div>
                <!-- below objects are for testing, will be changed/removed later -->
                <!-- <div class="cube dragtest" style="background-color:rgb(128, 255, 43)"></div>
                <div class="cube pathtest" style="background-color: rgb(204, 127, 255)"></div> -->
                <div class="circle" id="maincircle">
                    <canvas id="can"></canvas>
                    <div class="circlecenter"></div>
                </div>
            </div>
            <div id="playback-controls">
                PLAYBACK CONTROLS
                <div id="playback-grid">
                    <div>
                        <button id="play-pause">Play</button>
                        
                    </div>
                    <div id="speed-slider">
                        Playback Speed:
                        <input type="range" min="1" max="10" value="5" class="slider" id="playback-speed">
                    </div>
                </div>
            </div>
            
            <div id="object-menu">
                OBJECT MENU
                <table id="objects-table">
                    <tr>
                        <td>
                            
                            <div class="text-left">
                                <button type="button" id="add-object-button" class="btn btn-primary" onclick="addObjectButton()">+</button>
                                <label for="add-object-button">Add Object</label>
                             </div>
                        </td>
                        <td>

                        </td>
                    </tr>
                </table>
            </div>
            
            <div id="frame-controls">
                FRAME CONTROLS
				<table id="frames-table">
					<tr>
						<tfoot>
							<button style="margin:2px;" id="add-frame-button" onclick="addFrame()">+</button>
							<label for="add-frame-button">Add Frame&nbsp;</label>
							<button style="margin:2px;" id="remove-frame-button" onclick="removeFrame()">-</button>
							<label for="remove-frame-button">Remove Frame</label>
						</tfoot>
					</tr>
				</table>
			</div>
        </div>  


        <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/Draggable.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/MotionPathPlugin.min.js"></script>

        <script>
            //Defining templates for frame data
            var objectDataTemplate = {
                position:[0,0],
                bounds:[0,0],
                energyCubes:[]
            };

            var energyCubeDataTemplate = {
                type:"gravitational",
                value: 0.0
            };

            var frameStateTemplate = {};

            var frameData = [];
            var frame = 0;

            var nextObjectID = 0; // keeps track of the last object id assigned

            var table = document.getElementById("objects-table");
            var tableSize;

            var testButton = 0;
            var numObjectButtons = 0;
            var objectExpandButton = [20];
            var expand = [20];
            var zeroObjects = true;
            var energySpinnerIndexes = [10];

            var playPauseButton = document.getElementById("play-pause");
            
            playPauseButton.addEventListener("click", playPause);

            // create canvas, set to fill main circle
            var canvas = document.getElementById('can'),
                context = canvas.getContext('2d');
            canvas.style.width='100%';
            canvas.style.height='100%';
            canvas.width  = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            // method to redraw separating lines in circle
            function divideCircle() {
                context.clearRect(0, 0, canvas.width, canvas.height);
                var numObjects = nextObjectID;
                var radius = (canvas.width)/2;
                var slice = Math.PI * (2/numObjects);
                if(numObjects == 1) {
                    return;
                }
                context.beginPath();
                context.moveTo(radius, radius);
                for(let i = 0; i<numObjects; i++) {
                    var x = radius + (radius * Math.sin(i*slice));
                    var y = radius + (radius * Math.cos(i*slice));
                    context.lineTo(x, y);
                    context.lineTo(radius, radius);
                }
                context.stroke();
                
            }

            // ---- start of test / example code
            // Draggable.create(".dragtest");
            // gsap.to(".pathtest", {
            //     motionPath: {
            //         path: [{x:100, y:50}, {x:200, y:0}, {x:300, y:100}]
            //     },
            //     transformOrigin: "50% 50%",
            //     duration: 5,
            //     ease: "power1.inOut"
            // });
            // ---- end of test / example code
            //add object with given data
            function addObject(position, bounds) { 
                if (!position || !bounds){
                    console.log("no position or bounds! invalid objects");
                    return;
                }

                let newObj;

                newObj = JSON.parse(JSON.stringify(objectDataTemplate)); //deep copy our static object

                //assigning new object properties
                newObj.position = position;
                newObj.bounds = bounds; 

                let first = frameData[0];

                if (first){
                    first[toString(nextObjectID)] = newObj; //create new key in state dictionary
                    nextObjectID += 1;
                }
            }

            //Adds energy cube to existing frame state
            function addEnergyCube(objectKey, name, value){
                var owner = frameData[0][objectKey];
                var newObj = JSON.parse(JSON.stringify(energyCubeDataTemplate));
                if (owner){
                    if (name){
                        newObj.name = name;
                    }                
                    if (value){
                        newObj.value = value;
                    }
                    owner.energyCubes.push(newObj);
                }

            }
            //removes object based on key
            function removeObject(key) { 
                let first = frameData[0];
                if (first){
                    delete first[key];
                }
            }

            //adds new frame with previous state
            function addFrame(){
                let newFrame;
                
                if (frameData < 0){
                    newFrame = JSON.parse(JSON.stringify(frameStateTemplate)); //deep copy our frame state
                }else{
                    newFrame = JSON.parse(JSON.stringify(frameData[frameData.length - 1])); //deep copy our frame state
                }

                frameData.push(newFrame);
                frame = frameData.length - 1;
            }
            
            //removes the last frame
            function removeLastFrame(){
                frameData.pop();
                frame = frameData.length - 1;
            }
            //annimation = document.getElementById("physics-annimation");
            function playPause() { 

                if(testButton == 0){
                    playPauseButton.innerHTML = "Play";
                    //Functional goes here
                    testButton = 1;
                }
                else{
                    playPauseButton.innerHTML = "Pause";
                    //Functional goes here
                    testButton = 0;
                }
            } 

            function expandMenu(i) { 
                button = document.getElementById("expand" + i);
                if(expand[i] == 0){
                    button.innerHTML = "/\\";

                    expand[i] = 1;
                }
                else{
                    button.innerHTML = "\\/";

                    expand[i] = 0;
                }
                

            } 

            function addObjectButton(){
                numObjectButtons++;
                var currentIndex = numObjectButtons - 1;
                expand[currentIndex] = 0;
                
                addEntity

                tableSize = document.getElementById("objects-table").rows.length;

                var newRow = table.insertRow(tableSize);
                var newCell1 = newRow.insertCell(0);
                newCell1.innerHTML = "<button id=\"add-object-button\" onclick=\"addObjectButton()\">+</button><label for=\"add-object-button\">Add Object</label>";

                var tableSize = document.getElementById("objects-table").rows.length;
                document.getElementById("objects-table").deleteRow(tableSize - 1);

                var newRow = table.insertRow(tableSize - 2);
                var newCell1 = newRow.insertCell(0);
                newCell1.innerHTML = createNewObject(nextObjectID);
                
                //Adds object and increments nextObjectID
                addObject([0,0],[0,0]);

                divideCircle();

            }

            function addEnergy(i){
                energySpinnerIndexes[i]++;
                var energyTable = document.getElementById("energy-table" + i);
                var energyTableSize = document.getElementById("energy-table" + i).rows.length;
                var newRow = energyTable.insertRow(energyTableSize);
                var newCellContent = "<select name=\"energy-names\" class=\"energy-type\" id=\"energy-type\" text-align=\"center\">";
                newCellContent = newCellContent + "<option hidden=\"\">Energy Type</option><option value=\"kinetic\">Kinetic</option><option value=\"thermal\">Thermal</option><option value=\"gravitational\">Gravitational</option><option value=\"custom\">Custom</option></select>";
                newCellContent = newCellContent + "<input placeholder=\"Number\" required type=\"number\" value=\"\" min=\"0\" max=\"10\"/ id=\"energy-spin" + energySpinnerIndexes[i] + "\"></div>";
                var newCell = newRow.insertCell(0);
                newCell.innerHTML = newCellContent;
            }

            function createNewObject(objID){
                var returnString;
                var currentIndex = numObjectButtons - 1;
                returnString = "<input type=\"text\" class=\"obj_name_box\"  placeholder=\"Object Name\"></input> ";
                returnString = returnString + "<div class=\"text-right\"><button id=\"expand" + currentIndex + "\" class=\"btn btn-primary\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#collapseExample" + currentIndex + "\" aria-expanded=\"false\" aria-controls=\"collapseExample\" onclick=\"expandMenu(currentIndex)\">\\/</button></div>";
                returnString = returnString +  "<div class=\"collapse\" id=\"collapseExample" + currentIndex + "\"><div class=\"card card-body\">" + newEnergyMenu(objID) + "</div></div>";
                return returnString;
            }

            function newEnergyMenu(objID){
                var returnString;
                var currentIndex = numObjectButtons - 1;
                energySpinnerIndexes[currentIndex] = 0;

                returnString = "<div id=\"energy-menu\"><table id=\"energy-table" + currentIndex + "\"><tr><td>";
                returnString = returnString + "<select name=\"energy-names\" class=\"energy-type\" id=\"energy-type\" text-align=\"center\">";
                returnString = returnString + "<option hidden=\"\">Energy Type</option><option value=\"kinetic\">Kinetic</option><option value=\"thermal\">Thermal</option><option value=\"gravitational\">Gravitational</option><option value=\"custom\">Custom</option></select>";
                returnString = returnString + "<input placeholder=\"Number\" required type=\"number\" value=\"\" min=\"0\" max=\"10\"/ id=\"energy-spin" + energySpinnerIndexes[currentIndex] + "\"></div>"
                returnString = returnString + "</td><td></td></tr></table>";
                returnString = returnString + "<br><button id=\"add-energy-button\" onclick=\"addEnergy(" + currentIndex + ")\">+</button><label for=\"add-energy-button\">Add Energy Type</label>";

                return returnString;
            }

            $("input[type='number']").inputSpinner()

        </script>
		
		<script>
            function addFrame() {
                var table = document.getElementById("frames-table");
                var tableSize = document.getElementById("frames-table").rows[0].cells.length;
                var newCol = table.rows[0].insertCell(tableSize);
                var tableSize = document.getElementById("frames-table").rows[0].cells.length;
				newCol.innerHTML = "<button id=\"select-frame-button\" onclick=\"doNothing()\">" + (tableSize) + "</button>"; //make do something later
            }
        </script>
		<script>
		addFrame(); //add initial frame button
		</script>
		
		<script>
			function removeFrame() {
				var table = document.getElementById("frames-table");
				var tableSize = (document.getElementById("frames-table").rows[0].cells.length) - 1;
				var delCol = table.rows[0].deleteCell(tableSize);
			}
		</script>

        
        
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    </body>
</html>